<button id="newNote" onclick="newNote()">New Note</button>
<div style="border:1px solid #333333; width:1920px; height:1080px;"></div>

<style>
 .note{
  position: absolute;
  width: 150px;
  height: 150px;
  background-color: #fcc603;
  color: black;
}
.note .content{
  border: 0px;
  width: 97.5%;
  height: 120px;
  margin: 0px;
  resize: none;
  background-color: #fcc603;
  color: black;
}
.note .author{
  margin: 0px 5px;
  float: right;
}
.note .delete{
  margin: 0px 0px;
  height: 19px;
  width: 19px;
}
.note .move{
  margin: 0px 0px;
  width: 19px;
  height: 19px;
}
.hidden{
  display: none;
}

body{
  background-color: #333333;
  color: white;
}
</style>


<script>
const URL = "https://gameshub-post-it-server.boomboommushroom.repl.co"

function getCookie(cname){
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for (let i=0; i<ca.length;i++){
    let c = ca[i];
    while (c.charAt(0)==' '){
    c = c.substring(1);
    }
    if(c.indexOf(name)==0){
    return c.substring(name.length,c.length);
    }
  }
  return "";
}

function del(id){
	var confirmation = confirm("Are you sure you want to delete this note? This cannot be undone.")
  if(confirmation==false){return}
  //console.log(id)
  let token = getCookie("accToken")
  
  fetch(URL+'/deletenote?token='+token+'&uuid='+id,{})
  .then(response => response.text())
  .then(data => {
  	console.log(data)
  })
  
  updateAllNotes()
}
function edit(id){
	var content = document.getElementById(id+"Content")
  var editButton = document.getElementById(id+"Edit")
  
  if(content.disabled == true){
  	content.disabled = false
  	editButton.innerText = "Done"
  }
  else{
  	content.disabled = true
    editButton.innerText = "Edit"
    let txt = content.value
    
    fetch(URL+'/editnote?note='+txt+'&token='+getCookie("accToken")+'&uuid='+id,{})
    .then(response => response.text())
    .then(data => {
      console.log(data)
    })
    updateAllNotes()
  }
}

function loadNewNote(data){
	let parent = document.createElement("div")
  parent.classList.add("note")
  parent.id = data.UUID
  document.body.appendChild(parent)
  parent.style.left = data.position[0]+"px"
	parent.style.top = data.position[1]+"px"
  
  let textArea = document.createElement("textarea")
  textArea.classList.add("content")
  textArea.id = data.UUID+"Content"
  textArea.value = data.content
  textArea.disabled = true
  parent.appendChild(textArea)
  
  let span = document.createElement("span")
  span.classList.add("author")
  span.innerText = "- "+data.author
	parent.appendChild(span)
  
  let img1 = document.createElement("img")
  img1.classList.add("delete")
  if(getCookie("accToken") != data.token || data.author == "Anonymous"){
  	img1.classList.add("hidden")
  }
  img1.src = "https://icon-library.com/images/delete-icon-transparent-background/delete-icon-transparent-background-4.jpg"
  img1.onclick = ()=>{del(data.UUID)}
	parent.appendChild(img1)
  
  let btn = document.createElement("button")
  btn.classList.add("edit")
  if(getCookie("accToken") != data.token || data.author == "Anonymous"){
  	btn.classList.add("hidden")
  }
  btn.innerText = "Edit"
  btn.id = data.UUID+"Edit"
  btn.onclick = ()=>{edit(data.UUID)}
	parent.appendChild(btn)
  
  let img2 = document.createElement("img")
  img2.classList.add("move")
  if(getCookie("accToken") != data.token || data.author == "Anonymous"){
  	img2.classList.add("hidden")
  }
  img2.src = "https://icons.veryicon.com/png/o/miscellaneous/cockpit/drag-4.png"
  img2.id = data.UUID+"header"
	parent.appendChild(img2)
  
  dragElement( parent, data.position )
}

//Make the DIV element draggagle:
//dragElement(document.getElementById("placeholder"));

function dragElement(elmnt, pos) {
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  //if(pos != null){ pos3 = pos[0]; pos4 = pos[1] }
  
  if (document.getElementById(elmnt.id + "header")) {
    /* if present, the header is where you move the DIV from:*/
    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
  } else {
    /* otherwise, move the DIV from anywhere inside the DIV:*/
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    let x = parseInt(elmnt.style.left.split("px")[0])
    let y = parseInt(elmnt.style.top.split("px")[0])
  	/*
    let pos = [x, y]
    console.log(pos)
    */
    let token = ggetCookie("accToken")
    fetch(URL+'/movenote?x='+x+'&y='+y+'&token='+token+'&uuid='+elmnt.id,{})
    .then(response => response.text())
    .then(data => {
      console.log(data)
    })
  
    /* stop moving when mouse button is released:*/
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

function getExpire(){
	let units = prompt("Max units (seconds (1)/minutes (2)/hours (3)/days (4))")
  let amount = parseInt(prompt("Amount of units (ex. 1 day, 5 minutes, 2 hours, etc...)"))
  if(isNaN(amount)){ return -999 }
  let sMultiplier = 1
  let mMultiplier = 60
  let hMultiplier = 3600
  let dMultiplier = 86400
  
  let mPlier = units == "seconds" || units == "1" ? sMultiplier : units == "minutes" || units == "2" ? mMultiplier : units == "hours" || units == "3" ? hMultiplier : units == "days" || units == "4" ? dMultiplier : -999
  
  return amount * mPlier
}
function randInt(min, max){
	return Math.floor(Math.random() * (max-min))+min
}

function newNote(){
  let tkn = getCookie("accToken")
  let e = getExpire()
  if(e < 0){ return alert("Cancelled") }
  let anon = confirm("Use Anonymous (you can't modify the note afterwards)")
  let append = anon ? "&anom=true" : ''
  let note = prompt("Input: ")
  if(note == ""){ note = "CUSTOM_HELLO" }
  
  let x = randInt(0,(window.innerWidth-200))
  let y = randInt(0,(window.innerHeight-200))
  
  let addie = '/newnote?note='+note+'&token='+tkn+'&expire='+e+'&x='+x+'&y='+y+append
  
	fetch(URL+addie,{})
  .then(response => response.text())
  .then(data => {    
    updateAllNotes()
  })
}

function updateAllNotes(){
	fetch(URL+'/getnotes',{})
  .then(response => response.text())
  .then(data => {
  	let n = document.getElementsByClassName("note")
    for(var j=0;j<n.length;j++){
      n[j].remove()
    }
  
  	var d = JSON.parse(data)
    for(var i=0;i<d.length;i++){
    	let note = d[i]
      loadNewNote(note)
    }
  })
}


updateAllNotes()
setInterval(()=>{
	updateAllNotes()
}, 1000*60*2)
</script>
