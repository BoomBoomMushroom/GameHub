
<script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.2/dat.gui.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.js'></script>
<script src='https://dl.dropboxusercontent.com/s/qxgrvxduynnst3u/OrbitControls.js'></script>
  
<script src='https://raw.githubusercontent.com/saucecode/threejs-demos/master/MTLLoader.js'></script>
<script src='https://raw.githubusercontent.com/saucecode/threejs-demos/master/OBJLoader.js'></script>

<body></body>

<style>
  #pages{
    position: absolute;
    top: 10px;
    left: 20px;
    color: white;
    font-size: 30px;
    user-select: none;
  }
  #clear{
    position: absolute;
    top: 10px;
    right: 20px;
    color: white;
    background: transparent;
    border: none;
    font-size: 30px;
    user-select: none;
  }
  body{
    background-color: black;
  }
  *{
    margin: 0
  }
</style>

<script>
var scene, camera, renderer, mesh;
var meshFloor;
var players = []
var outOfBound = 30
var id = ""
var keyboard = {};
var player = { height:1.8, speed:0.2, turnSpeed:Math.PI*0.02 };
var USE_WIREFRAME = false;
var loadMesh = false;
var playerBodys = []

function newMesh(pos,rot){
	mesh = new THREE.Mesh(
		new THREE.BoxGeometry(1,3.6,1),
		new THREE.MeshBasicMaterial({color:0x4444ff, wireframe:USE_WIREFRAME})
	);
	mesh.position.x = pos.x
	mesh.position.y = pos.y
	mesh.position.z = pos.z
  mesh.rotation.x = rot.x
  mesh.rotation.y = rot.y
  mesh.rotation.z = rot.z
	scene.add(mesh);
  return mesh
}
function init(){
	scene = new THREE.Scene();
	camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 0.1, 1000);
  
	mesh = new THREE.Mesh(
		new THREE.BoxGeometry(1,3.6,1),
		new THREE.MeshBasicMaterial({color:0x4444ff, wireframe:USE_WIREFRAME})
	);
	mesh.position.y += 0;
	if(loadMesh===true){scene.add(mesh);}
  
	meshFloor = new THREE.Mesh(
		new THREE.PlaneGeometry(20,20, 10,10),
		new THREE.MeshBasicMaterial({color:0xffffff, wireframe:USE_WIREFRAME})
	);
	meshFloor.rotation.x -= Math.PI / 2; // Rotate the floor 90 degrees
	scene.add(meshFloor);
	
	camera.position.set(0, player.height, -5);
	camera.lookAt(new THREE.Vector3(0,player.height,0));
	
	renderer = new THREE.WebGLRenderer();
	renderer.setSize(window.innerWidth, window.innerHeight);
	document.body.appendChild(renderer.domElement);
	animate();
}

function animate(){
	requestAnimationFrame(animate);
	
  playerBodys.forEach(body=>{
  	scene.remove( body )
  })
  playerBodys = []
  players.forEach(player=>{
  	if(player.id==id){
    	camera.position.x = player.position.x;
      camera.position.y = player.position.y;
      camera.position.z = player.position.z;
      camera.rotation.y = player.rotation.y;
    } else{
      var body = newMesh(player.position,player.rotation)
      playerBodys.push(body)
    }
  })
	renderer.render(scene, camera);
}
function keyDown(event){
	keyboard[event.keyCode] = true;
  ws.send('keycode-'+event.keyCode+'-t')
}
function keyUp(event){
	keyboard[event.keyCode] = false;
  ws.send('keycode-'+event.keyCode+'-f')
}
function randomInt(min, max) {
  return Math.random() * (max - min) + min;
}

window.addEventListener('keydown', keyDown);
window.addEventListener('keyup', keyUp);

window.onload = init;
</script>

<script>
let HOST = 'wss://existancesimulator3dserver.academyofcode1.repl.co/'
      let ws = new WebSocket(HOST);
      let el;
      var playerId;

      function heartbeat(){
        clearTimeout(this.pingTimeout);
        
        this.pingTimeout = setTimeout(() => {
          this.terminate()
        }, 30000);
      }
      
      ws.onmessage = function incoming(data) {
        var msg = data.data
        if(msg.startsWith('[')){
          players = JSON.parse(msg); 
        }
        else if(msg.startsWith('id')){
        	id = msg.split('-')[1]
        }
        //console.log( JSON.parse(msg) )
      }
      
      ws.on('open', heartbeat);
      ws.on('ping', heartbeat);
      ws.on('close', function close() {
        clearTimeout(this.pingTimeout);
      })
</script>
